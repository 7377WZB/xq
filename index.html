<!DOCTYPE html>
<html lang="zh-TW">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockLab æˆ°æƒ…å®¤</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { width: 90%; max-width: 1000px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* é ‚éƒ¨å°è¦½åˆ— */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .brand { font-size: 24px; font-weight: bold; color: #2c3e50; }
        
        /* ä½¿ç”¨è€…æ‹›å‘¼èªæ¨£å¼ */
        #user-greeting { text-align: right; display: none; }
        .uid-text { font-weight: 900; font-size: 1.1em; color: #2c3e50; display: block; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; margin-top: 4px; }
        .badge-partner { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }
        .badge-vip { background: #fff8e1; color: #f57f17; border: 1px solid #ffecb3; }

        /* ä¸Šå‚³å€å¡Š */
        #drop-zone { 
            border: 3px dashed #cbd5e0; border-radius: 10px; padding: 50px; text-align: center; 
            color: #718096; transition: 0.3s; cursor: pointer; margin-bottom: 20px;
        }
        #drop-zone:hover, #drop-zone.dragover { border-color: #4299e1; background: #ebf8ff; color: #2b6cb0; }
        
        /* åœ–è¡¨å€ */
        #chart-area { display: none; }
        .chart-container { position: relative; height: 400px; width: 100%; }
        
        /* ç‹€æ…‹è¨Šæ¯ */
        #status-msg { color: #e53e3e; margin-top: 10px; display: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="brand">ğŸš€ StockLab æˆ°æƒ…å®¤</div>
        <div id="user-greeting"></div>
    </div>

    <div id="drop-zone">
        <h3>ğŸ“‚ è«‹å°‡ XQ é¸è‚¡ CSV æª”æ¡ˆæ‹–æ›³è‡³æ­¤</h3>
        <p>æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ (ç³»çµ±å°‡è‡ªå‹•é©—è­‰æ¬Šé™)</p>
        <input type="file" id="fileInput" accept=".csv" style="display:none">
        <div id="status-msg"></div>
    </div>

    <div id="chart-area">
        <h2 id="report-title">ğŸ“Š åˆ†æå ±è¡¨</h2>
        <div class="chart-container">
            <canvas id="stockChart"></canvas>
        </div>
        <p style="text-align:center; color:#888; margin-top:10px; font-size: 0.9em;">(è³‡æ–™ä¾†æºï¼šæ‚¨çš„ XQ é¸è‚¡ CSV)</p>
    </div>
</div>

<script>
    // ================= CONFIG =================
    // æ‚¨çš„ Google Script ç¶²å€ (å·²è‡ªå‹•å¡«å…¥)
    const LOG_API_URL = "https://script.google.com/macros/s/AKfycbyw83nI4PkO7IZGR39ZJ9spJhPcaba4BarxrH53TyQItOimloP9ont3gBmDDmn0ienw/exec"; 
    // ==========================================

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('fileInput');
    const statusMsg = document.getElementById('status-msg');

    // æ‹–æ›³äº‹ä»¶ç¶å®š
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });

    function handleFile(file) {
        statusMsg.style.display = 'none';
        const reader = new FileReader();
        reader.onload = (e) => {
            // XQ åŒ¯å‡ºé€šå¸¸æ˜¯ Big5ï¼Œè‹¥äº‚ç¢¼è«‹æ”¹ç”¨ Big5 è®€å–ï¼Œé€™è£¡æš«è¨­ UTF-8 æ–¹ä¾¿æ¸¬è©¦
            // è‹¥ XQ åŒ¯å‡ºçš„ CSV æ˜¯ç¹é«”ä¸­æ–‡ï¼Œå¯èƒ½éœ€è¦ç”¨ new TextDecoder("big5").decode(...)
            // é€™è£¡å…ˆç”¨æœ€é€šç”¨çš„æ–¹å¼è®€å–
            parseAndValidate(e.target.result);
        };
        // å˜—è©¦è®€å– (è‹¥ XQ é è¨­æ˜¯ Big5ï¼Œå»ºè­°ä¹‹å¾Œèª¿æ•´ reader åƒæ•¸)
        reader.readAsText(file); 
    }

    function parseAndValidate(csvText) {
        const lines = csvText.trim().split(/\r?\n/);
        if (lines.length < 2) {
            showError("âŒ æª”æ¡ˆå…§å®¹ç‚ºç©º");
            return;
        }

        // 1. è§£æè¡¨é ­æ‰¾ç°½ç« 
        // é æœŸæ ¼å¼: "æ—¥æœŸ#é©—è­‰ç¢¼-é¡åˆ¥-å¸³è™Ÿ-åˆ°æœŸæ—¥", "ä»£ç¢¼", ...
        const headerLine = lines[0];
        const headers = headerLine.split(',');
        
        // å°‹æ‰¾åŒ…å« "æ—¥æœŸ#" çš„æ¬„ä½
        const sigColIndex = headers.findIndex(h => h.includes('æ—¥æœŸ#'));
        
        if (sigColIndex === -1) {
            showError("âŒ é©—è­‰å¤±æ•—ï¼šé€™ä¸æ˜¯ StockLab å°ˆç”¨ CSV (ç¼ºå°‘ç°½ç« )");
            // é›–ç„¶å¤±æ•—ï¼Œä¹Ÿå·å·è¨˜ä¸€ç­† Unknown
            sendLog("Unknown", "0", "NoSignature");
            return;
        }

        // 2. æ‹†è§£ç°½ç« 
        // headers[sigColIndex] å¯èƒ½æ˜¯: "æ—¥æœŸ#5291-2-DavidWu-20260331"
        const rawHeader = headers[sigColIndex].replace(/"/g, '').trim(); // å»æ‰å¼•è™Ÿ
        const rawSig = rawHeader.split('#')[1]; // å–å¾— # å¾Œé¢çš„å­—ä¸²
        
        if (!rawSig) {
            showError("âŒ ç°½ç« æ ¼å¼éŒ¯èª¤");
            return;
        }

        const parts = rawSig.split('-'); // [é©—è­‰ç¢¼, é¡åˆ¥, å¸³è™Ÿ, åˆ°æœŸæ—¥]
        if (parts.length < 4) {
            showError("âŒ ç°½ç« è³‡è¨Šä¸å®Œæ•´");
            return;
        }

        const sigCode = parseInt(parts[0]);
        const type = parts[1];
        const uid = parts[2];
        const expiry = parts[3];

        // 3. æ•¸å­¸é©—è­‰ (é˜²å½)
        // éœ€å–å¾—ç¬¬ä¸€ç­†è³‡æ–™çš„æ—¥æœŸ
        const firstRow = lines[1].split(',');
        const dateStr = firstRow[sigColIndex].replace(/"/g, '').trim(); // 20260211
        const dateValue = parseInt(dateStr); 
        
        if (isNaN(dateValue)) {
             showError("âŒ æ—¥æœŸè®€å–éŒ¯èª¤ï¼Œè«‹ç¢ºèª CSV æ ¼å¼");
             return;
        }

        // â˜… é©—è­‰å…¬å¼ï¼š(æ—¥æœŸ * 3 + 888) % 10000
        const expectedCode = (dateValue * 3 + 888) % 10000;

        if (sigCode !== expectedCode) {
            showError(`âŒ é©—è­‰å¤±æ•—ï¼šæª”æ¡ˆå¯èƒ½å·²è¢«ç«„æ”¹ (Code: ${sigCode} vs ${expectedCode})`);
            sendLog(uid, type, "InvalidHash");
            return;
        }

        // 4. é©—è­‰æˆåŠŸï¼
        // é¡¯ç¤ºæ‹›å‘¼èª
        showGreeting(uid, type, expiry);
        
        // è¨˜éŒ„ Log (æˆåŠŸ)
        sendLog(uid, type, "Valid");

        // éš±è—ä¸Šå‚³å€ï¼Œé¡¯ç¤ºåœ–è¡¨
        document.getElementById('drop-zone').style.display = 'none';
        document.getElementById('chart-area').style.display = 'block';
        
        // ç¹ªè£½åœ–è¡¨ (ç›®å‰å…ˆç”¨å‡è³‡æ–™å±•ç¤ºï¼Œä¹‹å¾Œæˆ‘å€‘æœƒæ¥ä¸ŠçœŸå¯¦ CSV æ•¸æ“š)
        drawChart();
    }

    function showGreeting(uid, type, expiry) {
        const el = document.getElementById('user-greeting');
        let html = '';
        if (type === '1') {
            html = `<span class="uid-text">${uid}</span><span class="badge badge-partner">ğŸ¤ ç¶å®šåˆä½œå¤¥ä¼´</span>`;
        } else {
            // ç°¡å–®æ ¼å¼åŒ–æ—¥æœŸ
            const d = expiry; 
            const dateStr = d.length === 8 ? `${d.substr(0,4)}/${d.substr(4,2)}/${d.substr(6,2)}` : d;
            html = `<span class="uid-text">${uid}</span><span class="badge badge-vip">ğŸ‘‘ VIP (~${dateStr})</span>`;
        }
        el.innerHTML = html;
        el.style.display = 'block';
    }

    function showError(msg) {
        statusMsg.innerText = msg;
        statusMsg.style.display = 'block';
    }

    function sendLog(uid, type, status) {
        // ä½¿ç”¨ no-cors æ¨¡å¼ç™¼é€
        const url = `${LOG_API_URL}?uid=${encodeURIComponent(uid)}&type=${type}&status=${status}`;
        fetch(url, { method: 'POST', mode: 'no-cors' });
    }

    function drawChart() {
        const ctx = document.getElementById('stockChart').getContext('2d');
        // ç¯„ä¾‹åœ–è¡¨ï¼šå±•ç¤º PR èˆ‡ VR
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['å°ç©é›»', 'è¯ç™¼ç§‘', 'é•·æ¦®', 'é™½æ˜', 'è¬æµ·'],
                datasets: [{
                    label: 'ç±Œç¢¼ PR å€¼',
                    data: [85, 72, 90, 45, 60],
                    backgroundColor: 'rgba(54, 162, 235, 0.6)'
                }, {
                    label: 'é‡èƒ½ VR å€¼',
                    data: [60, 50, 80, 30, 95],
                    backgroundColor: 'rgba(255, 99, 132, 0.6)'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
</script>
</body>
</html>