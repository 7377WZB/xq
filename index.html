<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ªXQ CSV å¯¦é©—å®¤</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { width: 95%; max-width: 1200px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .brand { font-size: 24px; font-weight: bold; color: #2c3e50; }
        #user-greeting { text-align: right; display: none; }
        .uid-text { font-weight: 900; font-size: 1.1em; color: #2c3e50; display: block; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; margin-top: 4px; }
        .badge-vip { background: #fff8e1; color: #f57f17; border: 1px solid #ffecb3; }
        .badge-partner { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }
        #drop-zone { border: 3px dashed #cbd5e0; border-radius: 10px; padding: 50px; text-align: center; color: #718096; cursor: pointer; margin-bottom: 20px; transition: 0.3s; }
        #drop-zone:hover { border-color: #4299e1; background: #ebf8ff; }
        #chart-area { display: none; }
        .chart-container { position: relative; height: 500px; width: 100%; }
        #status-msg { color: #e53e3e; margin-top: 10px; display: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="brand">ğŸ§ªXQ CSV å¯¦é©—å®¤</div>
        <div id="user-greeting"></div>
    </div>

    <div id="drop-zone">
        <h3>ğŸ“‚ è«‹å°‡ XQ é¸è‚¡ CSV æ‹–æ›³è‡³æ­¤</h3>
        <p>æ”¯æ´æ¬„ä½é †åºï¼šä»£ç¢¼, åç¨±, PRå€¼, VRå€¼</p>
        <input type="file" id="fileInput" accept=".csv" style="display:none">
        <div id="status-msg"></div>
    </div>

    <div id="chart-area">
        <h2 id="report-title">ğŸ“Š é¸è‚¡åˆ†æå ±è¡¨</h2>
        <div class="chart-container">
            <canvas id="stockChart"></canvas>
        </div>
        <p style="text-align:center; color:#888; margin-top:10px;">(è³‡æ–™ä¾†æºï¼šæ‚¨çš„ XQ é¸è‚¡çµæœ)</p>
    </div>
</div>

<script>
    // â˜… è¨­å®šå€ â˜…
    const LOG_API_URL = "https://script.google.com/macros/s/AKfycbx8Kzqyt4F2_b-6t3zz0LEA6xaoDsX5kKiNbTK3uHpR675B1dNWtTPw9r3ReqppNJft/exec"; 
    
    // å…¨åŸŸè®Šæ•¸
    let myChart = null;

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('fileInput');
    const statusMsg = document.getElementById('status-msg');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
    fileInput.addEventListener('change', (e) => { if(e.target.files.length) handleFile(e.target.files[0]); });

    function handleFile(file) {
        statusMsg.style.display = 'none';
        const reader = new FileReader();
        reader.onload = (e) => parseAndValidate(e.target.result);
        reader.readAsText(file); // è‹¥ä¸­æ–‡äº‚ç¢¼å¯æ”¹ç”¨ 'Big5'
    }

    function parseAndValidate(csvText) {
        const lines = csvText.trim().split(/\r?\n/);
        if (lines.length < 2) return showError("âŒ æª”æ¡ˆå…§å®¹ç‚ºç©º");

        // --- é©—è­‰é‚è¼¯ ---
        const headers = lines[0].split(',');
        const sigColIndex = headers.findIndex(h => h.includes('æ—¥æœŸ#'));
        if (sigColIndex === -1) {
            sendLog("Unknown", "0", "NoSignature");
            return showError("âŒ æ ¼å¼éŒ¯èª¤ï¼šç¼ºå°‘ç°½ç« æ¬„ä½");
        }

        const rawSig = headers[sigColIndex].replace(/"/g, '').split('#')[1];
        if (!rawSig) return showError("âŒ ç°½ç« è®€å–å¤±æ•—");

        const parts = rawSig.split('-'); 
        if (parts.length < 4) return showError("âŒ ç°½ç« æ ¼å¼ä¸å®Œæ•´");

        const [sigCode, type, uid, expiry] = parts;
        
        // å–å¾—è³‡æ–™ç¬¬ä¸€è¡Œçš„æ—¥æœŸä¾†é©—è­‰ Hash
        const firstDataRow = lines[1].split(',');
        const dateVal = parseInt(firstDataRow[sigColIndex].replace(/"/g, ''));
        const expectedCode = (dateVal * 3 + 888) % 10000;

        if (parseInt(sigCode) !== expectedCode) {
            sendLog(uid, type, "InvalidHash");
            return showError(`âŒ é©—è­‰å¤±æ•—ï¼šç°½ç« ä¸ç¬¦ (Code Error)`);
        }

        // --- é©—è­‰æˆåŠŸï¼Œé–‹å§‹è™•ç†æ•¸æ“š ---
        showGreeting(uid, type, expiry);
        sendLog(uid, type, "Valid");

        // è§£ææ•¸æ“š (å‡è¨­ CSV æ¬„ä½é †åº: æ—¥æœŸ..., ä»£ç¢¼, åç¨±, PR, VR)
        // é€™è£¡æˆ‘å€‘åšä¸€å€‹è°æ˜çš„æœå°‹ï¼šæ‰¾ "åç¨±", "PR", "VR" æ‰€åœ¨çš„æ¬„ä½
        const nameIdx = headers.findIndex(h => h.includes('åç¨±'));
        // æ”¯æ´å¤šç¨®å¯«æ³•ï¼šPR, pr, ç±Œç¢¼...
        const prIdx = headers.findIndex(h => h.toUpperCase().includes('PR')); 
        const vrIdx = headers.findIndex(h => h.toUpperCase().includes('VR'));

        if (nameIdx === -1 || prIdx === -1 || vrIdx === -1) {
            alert("âš ï¸ æé†’ï¼šæ‰¾ä¸åˆ° 'åç¨±'ã€'PR' æˆ– 'VR' æ¬„ä½ï¼Œå°‡å˜—è©¦ä½¿ç”¨ç¬¬ 3,4,5 æ¬„ç¹ªåœ–ã€‚");
        }

        const chartData = { names: [], prs: [], vrs: [] };

        // å¾ç¬¬ 1 è¡Œ (æ•¸æ“šè¡Œ) é–‹å§‹è·‘
        for (let i = 1; i < lines.length; i++) {
            const row = lines[i].split(',');
            if (row.length < 3) continue;

            // å¦‚æœæ‰¾ä¸åˆ°æ¬„ä½åç¨±ï¼Œå°±é è¨­ç”¨ç¬¬ 2,3,4 æ¬„ (ç´¢å¼• 1,2,3)
            // æ³¨æ„ï¼šrow[0]æ˜¯æ—¥æœŸ, row[1]æ˜¯ä»£ç¢¼...
            const name = nameIdx > -1 ? row[nameIdx] : row[2]; 
            const pr = prIdx > -1 ? row[prIdx] : row[3];
            const vr = vrIdx > -1 ? row[vrIdx] : row[4];

            chartData.names.push(name.replace(/"/g, ''));
            chartData.prs.push(parseFloat(pr));
            chartData.vrs.push(parseFloat(vr));
        }

        // é¡¯ç¤ºåœ–è¡¨å€
        document.getElementById('drop-zone').style.display = 'none';
        document.getElementById('chart-area').style.display = 'block';
        drawChart(chartData);
    }

    function showGreeting(uid, type, expiry) {
        const el = document.getElementById('user-greeting');
        const d = expiry; 
        const dateStr = d.length === 8 ? `${d.substr(0,4)}/${d.substr(4,2)}/${d.substr(6,2)}` : d;
        const badgeClass = type === '1' ? 'badge-partner' : 'badge-vip';
        const badgeText = type === '1' ? 'ğŸ¤ åˆä½œå¤¥ä¼´' : `ğŸ‘‘ VIP (~${dateStr})`;
        
        el.innerHTML = `<span class="uid-text">${uid}</span><span class="badge ${badgeClass}">${badgeText}</span>`;
        el.style.display = 'block';
    }

    function showError(msg) {
        statusMsg.innerText = msg;
        statusMsg.style.display = 'block';
    }

    function sendLog(uid, type, status) {
        fetch(`${LOG_API_URL}?uid=${encodeURIComponent(uid)}&type=${type}&status=${status}`, { method: 'POST', mode: 'no-cors' });
    }

    function drawChart(data) {
        const ctx = document.getElementById('stockChart').getContext('2d');
        if (myChart) myChart.destroy(); // å¦‚æœèˆŠåœ–è¡¨å­˜åœ¨ï¼Œå…ˆéŠ·æ¯€

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.names, // ä½¿ç”¨ CSV è£¡çš„è‚¡ç¥¨åç¨±
                datasets: [{
                    label: 'ç±Œç¢¼ PR',
                    data: data.prs, // ä½¿ç”¨ CSV è£¡çš„ PR æ•¸å€¼
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }, {
                    label: 'é‡èƒ½ VR',
                    data: data.vrs, // ä½¿ç”¨ CSV è£¡çš„ VR æ•¸å€¼
                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100 } // å‡è¨­ PR/VR æ»¿åˆ†æ˜¯ 100
                }
            }
        });
    }

    /**
     * è§£æ XS æ··æ·†å­—ä¸²
     * è¼¸å…¥ç¯„ä¾‹: "TradeDate#WrTywQprQbbjKCOTSEQEU"
     */
    function parseXQSignature(fullString) {
        const HEADER = "TradeDate#";
        
        // 1. åŸºç¤æª¢æ ¸
        if (!fullString || !fullString.startsWith(HEADER)) {
            return { valid: false, message: "æ ¼å¼éŒ¯èª¤" };
        }

        // ç§»é™¤ Headerï¼Œå–å¾—å…§å®¹æœ¬é«”
        const content = fullString.substring(HEADER.length);
        
        // å®šç¾©å°ç…§è¡¨ (å¿…é ˆèˆ‡ XS å®Œå…¨ä¸€è‡´)
        const MAP_DATE = "QwErTyUiOp";   // 0-9
        const MAP_ID   = "abcdefghij";   // 0-9

        // è¼”åŠ©å‡½å¼: é‚„åŸå–®ä¸€å­—å…ƒ (æŸ¥è¡¨ MAP_DATE)
        function decodeDigit(char) {
            const idx = MAP_DATE.indexOf(char);
            return idx > -1 ? idx.toString() : "?";
        }

        // ==========================================
        // 2. åˆ‡å‰²å­—ä¸²
        // çµæ§‹: [Sig:4] + [Status:1] + [MMDD:4] + [ID:è®Šå‹•] + [YYYY:4]
        // ==========================================
        
        // å›ºå®šé•·åº¦æª¢æŸ¥
        if (content.length < 13) return { valid: false, message: "é•·åº¦ä¸è¶³" };

        const encSig    = content.substring(0, 4);
        const encStatus = content.substring(4, 5); // ç¬¬5ç¢¼
        const encMMDD   = content.substring(5, 9); // 6-9ç¢¼
        const encYYYY   = content.substring(content.length - 4); // æœ€å¾Œ4ç¢¼
        const encID     = content.substring(9, content.length - 4); // ä¸­é–“å‰©é¤˜éƒ¨åˆ†

        // ==========================================
        // 3. é‚„åŸé‚è¼¯
        // ==========================================

        // A. é‚„åŸç‹€æ…‹ (1=æ­£å¸¸, 2=éæœŸ)
        const status = decodeDigit(encStatus);
        const isExpired = (status !== "1"); 

        // B. é‚„åŸæ—¥æœŸ (YYYY + MMDD)
        let yyyy = "";
        for (let c of encYYYY) yyyy += decodeDigit(c);
        
        let mmdd = "";
        for (let c of encMMDD) mmdd += decodeDigit(c);

        const fullDate = yyyy + mmdd;
        const isPermanent = (fullDate === "13572468"); // ç‰¹æ®Šä»£ç¢¼

        // C. é‚„åŸ ID (æ•¸å­—é‚„åŸ + å­—ä¸²åè½‰)
        let rawIDReversed = "";
        for (let c of encID) {
            const idx = MAP_ID.indexOf(c);
            if (idx > -1) {
                rawIDReversed += idx.toString(); // a-j -> 0-9
            } else {
                rawIDReversed += c; // åŸå­—å…ƒ (å¤§å¯«å­—æ¯)
            }
        }
        // JS åè½‰å­—ä¸²
        const finalID = rawIDReversed.split("").reverse().join("");

        // ==========================================
        // 4. å›å‚³çµæœç‰©ä»¶
        // ==========================================
        return {
            valid: true,
            userID: finalID,
            date: isPermanent ? "ç„¡æœŸé™" : `${yyyy}/${mmdd.substring(0,2)}/${mmdd.substring(2)}`,
            status: status, // 1 or 2
            isExpired: isExpired,
            rawDate: fullDate
        };
    }

    // --- æ¸¬è©¦ç¯„ä¾‹ ---
    // å‡è¨­è¼¸å…¥: "TradeDate#WrTywQprQbbjKCOTSEQEU" (WrTy=åŠ å¯†é˜²å½, w=ç‹€æ…‹1, QprQ=0930, bbjKCOTS=ID, EQEU=2026)
    // console.log(parseXQSignature("TradeDate#WrTywQprQbbjKCOTSEQEU"));
</script>
</body>
</html>