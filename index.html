<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª XQ CSV å¯¦é©—å®¤</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { width: 95%; max-width: 1200px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .brand { font-size: 24px; font-weight: bold; color: #2c3e50; }
        #user-greeting { text-align: right; display: none; }
        .uid-text { font-weight: 900; font-size: 1.1em; color: #2c3e50; display: block; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; margin-top: 4px; }
        .badge-vip { background: #fff8e1; color: #f57f17; border: 1px solid #ffecb3; }
        .badge-partner { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }
        #drop-zone { border: 3px dashed #cbd5e0; border-radius: 10px; padding: 50px; text-align: center; color: #718096; cursor: pointer; margin-bottom: 20px; transition: 0.3s; }
        #drop-zone:hover { border-color: #4299e1; background: #ebf8ff; }
        #chart-area { display: none; }
        .chart-container { position: relative; height: 500px; width: 100%; }
        #status-msg { color: #e53e3e; margin-top: 10px; display: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="brand">ğŸ§ªXQ CSV å¯¦é©—å®¤</div>
        <div id="user-greeting"></div>
    </div>

    <div id="drop-zone">
        <h3>ğŸ“‚ è«‹å°‡ XQ é¸è‚¡ CSV æ‹–æ›³è‡³æ­¤</h3>
        <p>æ”¯æ´æ¬„ä½é †åºï¼šä»£ç¢¼, åç¨±, PRå€¼, VRå€¼</p>
        <input type="file" id="fileInput" accept=".csv" style="display:none">
        <div id="status-msg"></div>
    </div>

    <div id="chart-area">
        <h2 id="report-title">ğŸ“Š é¸è‚¡åˆ†æå ±è¡¨</h2>
        <div class="chart-container">
            <canvas id="stockChart"></canvas>
        </div>
        <p style="text-align:center; color:#888; margin-top:10px;">(è³‡æ–™ä¾†æºï¼šæ‚¨çš„ XQ é¸è‚¡çµæœ)</p>
    </div>
</div>

<script>
    // â˜… è¨­å®šå€ â˜…
    const LOG_API_URL = "https://script.google.com/macros/s/AKfycbx8Kzqyt4F2_b-6t3zz0LEA6xaoDsX5kKiNbTK3uHpR675B1dNWtTPw9r3ReqppNJft/exec"; 
    
    // å…¨åŸŸè®Šæ•¸
    let myChart = null;

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('fileInput');
    const statusMsg = document.getElementById('status-msg');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
    fileInput.addEventListener('change', (e) => { if(e.target.files.length) handleFile(e.target.files[0]); });

    function handleFile(file) {
        statusMsg.style.display = 'none';
        const reader = new FileReader();
        reader.onload = (e) => parseAndValidate(e.target.result);
        // â˜… å¼·åˆ¶æŒ‡å®š Big5 ç·¨ç¢¼ (è§£æ±ºä¸­æ–‡äº‚ç¢¼èˆ‡å®šä½åç§»)
        reader.readAsText(file, 'Big5');
    }

    function parseAndValidate(csvText) {
        // 1. åˆ‡å‰²è¡Œ (è™•ç†å„ç¨®æ›è¡Œç¬¦è™Ÿ)
        const lines = csvText.trim().split(/\r?\n/);
        
        // 2. â˜… é—œéµä¿®æ­£ï¼šå‹•æ…‹å°‹æ‰¾è¡¨é ­æ‰€åœ¨çš„è¡Œæ•¸
        // æˆ‘å€‘ä¸å‡è¨­å®ƒåœ¨ç¬¬å¹¾è¡Œï¼Œè€Œæ˜¯ç›´æ¥æ‰¾å“ªä¸€è¡Œæœ‰ "TradeDate#"
        let headerRowIndex = -1;
        let headers = [];

        for (let i = 0; i < lines.length; i++) {
            // ç°¡å–®åˆ¤æ–·ï¼šè©²è¡ŒåŒ…å« "TradeDate#" ä¸”æœ‰ "ä»£ç¢¼" æˆ– "å•†å“"
            if (lines[i].includes('TradeDate#')) {
                headerRowIndex = i;
                // åˆ‡å‰²ä¸¦å»é™¤å¼•è™Ÿ
                headers = lines[i].split(',').map(h => h.trim().replace(/"/g, ''));
                break;
            }
        }

        if (headerRowIndex === -1) {
            return showError("âŒ æ ¼å¼éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° 'TradeDate#' ç°½ç« æ¬„ä½ï¼Œè«‹ç¢ºèªé€™æ˜¯æ­£ç¢ºçš„ XQ åŒ¯å‡ºæª”ã€‚");
        }

        // 3. æŠ“å‡ºåŠ å¯†ç°½ç« å­—ä¸² (Column Name)
        // å°‹æ‰¾ headers é™£åˆ—ä¸­ï¼Œé–‹é ­æ˜¯ TradeDate# çš„é‚£å€‹æ¬„ä½
        const sigColIndex = headers.findIndex(h => h.startsWith('TradeDate#'));
        if (sigColIndex === -1) return showError("âŒ ç°½ç« æ¬„ä½å®šä½å¤±æ•—");

        const headerString = headers[sigColIndex]; // ä¾‹å¦‚: "TradeDate#wyEwEQQpQOKCOTSEQEU"

        // 4. æŠ“å‡ºè³‡æ–™åˆ— (è¡¨é ­çš„ä¸‹ä¸€è¡Œ)
        if (lines.length <= headerRowIndex + 1) return showError("âŒ æª”æ¡ˆä¸­æ²’æœ‰è³‡æ–™");
        
        const firstDataRowRaw = lines[headerRowIndex + 1];
        const firstDataRow = firstDataRowRaw.split(',');
        
        // å–å¾—è©²æ¬„ä½çš„æ—¥æœŸå€¼ (ä¾‹å¦‚: "20260211/20260210/...")
        // è¨˜å¾—å»é™¤å¼•è™Ÿ
        let rawDateValue = firstDataRow[sigColIndex].trim().replace(/"/g, '');
        
        // â˜… é—œéµä¿®æ­£ï¼šXQ è³‡æ–™æ˜¯ "20260211/20260210..."ï¼Œæˆ‘å€‘åªå–ç¬¬ä¸€å€‹ (æœ€æ–°æ—¥æœŸ)
        if (rawDateValue.includes('/')) {
            rawDateValue = rawDateValue.split('/')[0];
        }

        // 5. åŸ·è¡Œé˜²å½é©—è­‰
        const isSafe = verifyCSV(headerString, rawDateValue);

        if (!isSafe) {
            sendLog("Unknown", "0", "InvalidSignature");
            return showError("âŒ é©—è­‰å¤±æ•—ï¼šé˜²å½ç°½ç« ä¸ç¬¦æˆ–æª”æ¡ˆé­ç¯¡æ”¹");
        }

        // 6. é©—è­‰é€šéï¼Œè§£æä¸¦é¡¯ç¤º User è³‡è¨Š
        const userInfo = parseXQSignature(headerString);
        if (userInfo.isExpired) {
            sendLog(userInfo.userID, userInfo.status, "Expired");
            return showError(`âŒ æ‚¨çš„æ¬Šé™å·²æ–¼ ${userInfo.date} åˆ°æœŸ`);
        }

        showGreeting(userInfo.userID, userInfo.status, userInfo.rawDate);
        sendLog(userInfo.userID, userInfo.status, "Valid");

        // 7. é–‹å§‹ç¹ªåœ– (å¾è³‡æ–™åˆ—é–‹å§‹è®€å–)
        // å‹•æ…‹æœå°‹æ¬„ä½ç´¢å¼•
        const nameIdx = headers.findIndex(h => h.includes('å•†å“') || h.includes('åç¨±'));
        const prIdx = headers.findIndex(h => h.toUpperCase().includes('PR') || h.toUpperCase().includes('PRICE')); 
        const vrIdx = headers.findIndex(h => h.toUpperCase().includes('VR') || h.toUpperCase().includes('VOLRANK'));

        if (nameIdx === -1 || prIdx === -1 || vrIdx === -1) {
            alert("âš ï¸ æé†’ï¼šæ‰¾ä¸åˆ° 'å•†å“'ã€'PR' æˆ– 'VR' æ¬„ä½ï¼Œå°‡å˜—è©¦ä½¿ç”¨é è¨­ä½ç½®ç¹ªåœ–ã€‚");
        }

        const chartData = { names: [], prs: [], vrs: [] };

        // å¾ headerRowIndex + 1 é–‹å§‹è·‘å›åœˆ (å³è³‡æ–™å€)
        for (let i = headerRowIndex + 1; i < lines.length; i++) {
            // è·³éç©ºè¡Œ
            if (!lines[i].trim()) continue;

            const row = lines[i].split(',');
            // ç¢ºä¿æ¬„ä½è¶³å¤ 
            if (row.length < sigColIndex) continue;

            // å–å€¼ä¸¦å»å¼•è™Ÿ
            const getName = (idx, fallback) => idx > -1 && row[idx] ? row[idx].replace(/"/g, '').trim() : row[fallback];
            const getNum = (idx, fallback) => {
                let val = idx > -1 && row[idx] ? row[idx].replace(/"/g, '').trim() : row[fallback];
                return parseFloat(val) || 0;
            };

            // è‹¥æ‰¾ä¸åˆ°æ¬„ä½ï¼Œé è¨­ fallback åˆ° 2, 12, 13 (ä¾æ‚¨æä¾›çš„ CSV çµæ§‹: å•†å“=2, PriceRank=12, VolRank=13)
            // æ³¨æ„ CSV split å¾Œçš„ index å¯èƒ½å› é€—è™Ÿè€Œè®Šï¼Œå»ºè­°ä¾è³´ findIndex
            const name = getName(nameIdx, 2); 
            const pr = getNum(prIdx, 12);
            const vr = getNum(vrIdx, 13);

            // ç°¡å–®éæ¿¾ç„¡æ•ˆè³‡æ–™
            if (name) {
                chartData.names.push(name);
                chartData.prs.push(pr);
                chartData.vrs.push(vr);
            }
        }

        document.getElementById('drop-zone').style.display = 'none';
        document.getElementById('chart-area').style.display = 'block';
        drawChart(chartData);
    }

    function showGreeting(uid, type, expiry) {
        const el = document.getElementById('user-greeting');
        const d = expiry; 
        const dateStr = d.length === 8 ? `${d.substr(0,4)}/${d.substr(4,2)}/${d.substr(6,2)}` : d;
        const badgeClass = type === '1' ? 'badge-partner' : 'badge-vip';
        const badgeText = type === '1' ? 'ğŸ¤ åˆä½œå¤¥ä¼´' : `ğŸ‘‘ VIP (~${dateStr})`;
        
        el.innerHTML = `<span class="uid-text">${uid}</span><span class="badge ${badgeClass}">${badgeText}</span>`;
        el.style.display = 'block';
    }

    function showError(msg) {
        statusMsg.innerText = msg;
        statusMsg.style.display = 'block';
    }

    function sendLog(uid, type, status) {
        fetch(`${LOG_API_URL}?uid=${encodeURIComponent(uid)}&type=${type}&status=${status}`, { method: 'POST', mode: 'no-cors' });
    }

    function drawChart(data) {
        const ctx = document.getElementById('stockChart').getContext('2d');
        if (myChart) myChart.destroy(); // å¦‚æœèˆŠåœ–è¡¨å­˜åœ¨ï¼Œå…ˆéŠ·æ¯€

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.names, // ä½¿ç”¨ CSV è£¡çš„è‚¡ç¥¨åç¨±
                datasets: [{
                    label: 'ç±Œç¢¼ PR',
                    data: data.prs, // ä½¿ç”¨ CSV è£¡çš„ PR æ•¸å€¼
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }, {
                    label: 'é‡èƒ½ VR',
                    data: data.vrs, // ä½¿ç”¨ CSV è£¡çš„ VR æ•¸å€¼
                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100 } // å‡è¨­ PR/VR æ»¿åˆ†æ˜¯ 100
                }
            }
        });
    }

    /**
     * è§£æ XS æ··æ·†å­—ä¸²
     * è¼¸å…¥ç¯„ä¾‹: "TradeDate#WrTywQprQbbjKCOTSEQEU"
     */

/**
 * 1. è§£æ XS æ··æ·†å­—ä¸² (æ ¸å¿ƒå‡½å¼)
 */
    function parseXQSignature(fullString) {
        const HEADER = "TradeDate#";
        
        // åŸºç¤æª¢æ ¸
        if (!fullString || !fullString.startsWith(HEADER)) {
            return { valid: false, message: "æ ¼å¼éŒ¯èª¤" };
        }

        const content = fullString.substring(HEADER.length);
        const MAP_DATE = "QwErTyUiOp";   // 0-9
        const MAP_ID   = "abcdefghij";   // 0-9

        function decodeDigit(char) {
            const idx = MAP_DATE.indexOf(char);
            return idx > -1 ? idx.toString() : "?";
        }

        if (content.length < 13) return { valid: false, message: "é•·åº¦ä¸è¶³" };

        const encSig    = content.substring(0, 4);
        const encStatus = content.substring(4, 5); 
        const encMMDD   = content.substring(5, 9); 
        const encYYYY   = content.substring(content.length - 4); 
        const encID     = content.substring(9, content.length - 4); 

        // --- A. é‚„åŸé˜²å½ç°½ç«  (é€™æ˜¯æ–°å¢çš„ä¿®æ”¹) ---
        let sigStr = "";
        for (let c of encSig) sigStr += decodeDigit(c);
        const signature = parseInt(sigStr, 10); // è½‰æˆæ•¸å­—ï¼Œä¾‹å¦‚ 1521

        // --- B. é‚„åŸæ—¥æœŸ (æœŸé™) ---
        let yyyy = ""; for (let c of encYYYY) yyyy += decodeDigit(c);
        let mmdd = ""; for (let c of encMMDD) mmdd += decodeDigit(c);
        const fullDate = yyyy + mmdd;
        const isPermanent = (fullDate === "13572468");

        // --- C. é‚„åŸç‹€æ…‹ & éæœŸåˆ¤æ–· ---
        const status = decodeDigit(encStatus);
        let isExpired = false;
        
        if (!isPermanent) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            // JS æœˆä»½å¾ 0 é–‹å§‹
            const expDate = new Date(parseInt(yyyy), parseInt(mmdd.substring(0, 2)) - 1, parseInt(mmdd.substring(2)));
            if (expDate < today) {
                isExpired = true;
            }
        }

        // --- D. é‚„åŸ ID ---
        let rawIDReversed = "";
        for (let c of encID) {
            const idx = MAP_ID.indexOf(c);
            if (idx > -1) rawIDReversed += idx.toString();
            else rawIDReversed += c;
        }
        const finalID = rawIDReversed.split("").reverse().join("");

        return {
            valid: true,
            signature: signature, // å›å‚³è§£ç¢¼å¾Œçš„ç°½ç«  (ä¾‹å¦‚ 1521)
            userID: finalID,
            date: isPermanent ? "ç„¡æœŸé™" : `${yyyy}/${mmdd.substring(0,2)}/${mmdd.substring(2)}`,
            status: status, 
            statusText: (status === "1") ? "ç¶å®šæˆ¶" : "VIP",
            isExpired: isExpired,
            rawDate: fullDate
        };
    }

/**
 * 2. é©—è­‰ CSV æ˜¯å¦å½é€  (é€™æ˜¯ç¬¬äºŒæ­¥çš„å¯¦ä½œ)
 * * @param {string} headerString - CSV ç¬¬ä¸€æ¬„çš„æ¨™é ­ (åŒ…å« TradeDate#...)
 * @param {string} firstDateValue - CSV ç¬¬ä¸€æ¬„ç¬¬ä¸€åˆ—çš„æ—¥æœŸ (ä¾‹å¦‚ "20260212")
 */
    function verifyCSV(headerString, firstDateValue) {
        // 1. å…ˆè§£æè¡¨é ­
        const info = parseXQSignature(headerString);
        
        if (!info.valid) {
            console.error("è¡¨é ­è§£æå¤±æ•—:", info.message);
            return false;
        }

        // 2. å–å¾— CSV å…§çš„è³‡æ–™æ—¥æœŸ (éœ€è½‰ç‚ºç´”æ•¸å­—)
        // å‡è¨­å‚³å…¥çš„æ˜¯ "20260212" æˆ– "2026/02/12"
        const cleanDateStr = firstDateValue.replace(/\//g, "").replace(/-/g, "");
        const dataDate = parseInt(cleanDateStr, 10);

        // 3. åŸ·è¡Œé˜²å½å…¬å¼ (å¿…é ˆèˆ‡ XS ä¸€æ¨¡ä¸€æ¨£)
        // å…¬å¼: (æ—¥æœŸ * 3 + 888) % 10000
        const calculatedSig = (dataDate * 3 + 888) % 10000;

        // 4. æ¯”å°
        if (calculatedSig !== info.signature) {
            console.warn(`é˜²å½è­¦å‘Š: è¨ˆç®—å€¼(${calculatedSig}) èˆ‡ ç°½ç« å€¼(${info.signature}) ä¸ç¬¦ï¼`);
            alert("è­¦å‘Šï¼šæ­¤æª”æ¡ˆå¯èƒ½å·²ç¶“éæœŸæˆ–æ˜¯è¢«ç¯¡æ”¹ï¼(ç°½ç« é©—è­‰å¤±æ•—)");
            return false; // é©—è­‰å¤±æ•—
        }

        console.log("âœ… é˜²å½é©—è­‰é€šéï¼");
        return true; // é©—è­‰æˆåŠŸ
    }

</script>
</body>
</html>